<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
  <!-- <script src="http://www.chartjs.org/samples/latest/utils.js"></script> -->
  <script src="../js/dashboard.js"></script>
  <script src="../js/animacao.js"></script>

  <script
    src="https://desk.zoho.com/portal/api/feedbackwidget/861047000000250005?orgId=811102377&displayType=popout"></script>

  <script src="../js/funcoes.js"></script>
  <link rel="stylesheet" href="../Estilo/dashboard.css" />
  <link rel="shortcut icon" href="../assets/Imagens/logo_imagem.png" type="image/x-icon" />
  <title>Safe Lawn - Dashboard</title>
</head>

<body>
  <div class="sidebar" id="sidebar">
    <div class="menu">
      <div class="menu-button ativada" id="menu" onclick="movimentar()">
        <div class="menu-traco"></div>
        <div class="menu-traco"></div>
        <div class="menu-traco"></div>
      </div>
      <div class="menu-button desativada" id="menu-desativado" onclick="movimentar()">
        <div class="menu-traco"></div>
        <div class="menu-traco"></div>
        <div class="menu-traco"></div>
      </div>
    </div>
    <div class="container-sidebar">
      <div class="conteudo">
        <div class="header-sidebar">
          <div class="header-logo">
            <img src="../assets/Imagens/logo-SafeLawn.png">
          </div>
          <div class="header-titulo">
            <h1 class="nome-perfil" id="nome_estadio">Nome clube</h1>
          </div>
        </div>
        <div class="flex-link">
          <a href="cadastro_funcionario.html">
            Cadastrar novo funcionario
          </a>
          <a href="#">
            <button class="btn_sair" onclick="">SAIR</button>
          </a>
        </div>
      </div>
      
    </div>
  </div>
  <div class="dashboard-section">
    <div class="dashboard-wrapper">
      <div class="container">
        <div class="grupo-card">
          <div class="card card-sensores card-1">
            <div>
              <!-- <span class="card-date">24/04/2023 - 13:55</span> -->
              <h3>Setor 1</h3>
            </div>

            <div class="row">
              <img src="../assets/icon/icone-umidade.png" alt="">
              <h2 class="dados-card">33%</h2>
            </div>
            <p class="texto-card">23/05/2023 12:50</p>
          </div>
          <div class="card card-sensores card-2">
            <div>
              <!-- <span class="card-date">24/04/2023 - 13:55</span> -->
              <h3>Setor 2</h3>
            </div>

            <div class="row">
              <img src="../assets/icon/icone-umidade.png" alt="">
              <h2 class="dados-card">33%</h2>
            </div>
            <p class="texto-card">23/05/2023 12:50</p>
          </div>
          <div class="card card-sensores card-3">
            <div>
              <!-- <span class="card-date">24/04/2023 - 13:55</span> -->
              <h3>Setor 3</h3>
            </div>

            <div class="row">
              <img src="../assets/icon/icone-umidade.png" alt="">
              <h2 class="dados-card">33%</h2>
            </div>
            <p class="texto-card">23/05/2023 12:50</p>
          </div>
          <div class="card card-sensores card-4">
            <div>
              <!-- <span class="card-date">24/04/2023 - 13:55</span> -->
              <h3>Setor 4</h3>
            </div>

            <div class="row">
              <img src="../assets/icon/icone-umidade.png" alt="">
              <h2 class="dados-card">33%</h2>
            </div>
            <p class="texto-card">23/05/2023 12:50</p>
          </div>


        </div>

        </section>

      </div>
      <div class="graficos-container">
          <button onclick="modal()" class="popup-info">i</button>
        <div id="grafico1" class="display-block">
          <h3 class="tituloGraficos">
            <span id="tituloAquario1"></span>
          </h3>
          <div class="graph">
            <canvas id="myChartCanvas1"></canvas>
          </div>
          <div class="label-captura">
            <p id="avisoCaptura1" style="color: white ; position: absolute; bottom: 5%;"></p>
          </div>
        </div>

        <!-- <div id="grafico_geral" class="grafico">
                            <canvas id="dht11Umidade"></canvas>
                        </div> -->

        <!-- <div id="grafico_historico" class="grafico">
                            <canvas id="historico"></canvas>
                        </div> -->

        <div class="alertas" id="alertas">
          <div id="al1" class="alerta">
            <div class="al-icone">
              <img src="../assets/Imagens/alerta-icon.png" alt="ALERTA" class="al-icone-img">
            </div>
            <div class="al-info">
              <p>Setor <span id="al_setor1" class="al-setor"> X </span></p>
              <div>
                <h3>Estado de <span id="al_estado1" class="al-estado"> Perigo </span></h3>
                <p>Umidade em <b id="al_umidade1" class="al-umidade"> Y% </b></p>
              </div>
            </div>
          </div>

          <div id="al2" class="alerta">
            <div class="al-icone">
              <img src="../assets/Imagens/alerta-icon.png" alt="ALERTA" class="al-icone-img">
            </div>
            <div class="al-info">
              <p>Setor <span id="al_setor2" class="al-setor"> X </span></p>
              <div>
                <h3>Estado de <span id="al_estado2" class="al-estado"> Perigo </span></h3>
                <p>Umidade em <b id="al_umidade2" class="al-umidade"> Y% </b></p>
              </div>
            </div>
          </div>

          <div id="al3" class="alerta">
            <div class="al-icone">
              <img src="../assets/Imagens/alerta-icon.png" alt="ALERTA" class="al-icone-img">
            </div>
            <div class="al-info">
              <p>Setor <span id="al_setor3" class="al-setor"> X </span></p>
              <div>
                <h3>Estado de <span id="al_estado3" class="al-estado"> Perigo </span></h3>
                <p>Umidade em <b id="al_umidade3" class="al-umidade"> Y% </b></p>
              </div>
            </div>
          </div>

          <div id="al4" class="alerta">
            <div class="al-icone">
              <img src="../assets/Imagens/alerta-icon.png" alt="ALERTA" class="al-icone-img">
            </div>
            <div class="al-info">
              <p>Setor <span id="al_setor4" class="al-setor"> X </span></p>
              <div>
                <h3>Estado de <span id="al_estado4" class="al-estado"> Perigo </span></h3>
                <p>Umidade em <b id="al_umidade4" class="al-umidade"> Y% </b></p>
              </div>
            </div>
          </div>

        </div>


      </div>
    </div>
  </div>
  </div>
  </div>
  <br />

  </div>

  <div id="pop_up" class="popup-wrapper disable">
    <div class="popup">
      <div class="container">
        
        <div class="row">
          <div class="color red"></div>
          <p class="popup-text">Vermelho: Precisa ser resolvido imediatamente! Isso acontece quando seu sensor passa dos extremos de umidade.</p>
        </div>

        <div class="row">
          <div class="color yellow"></div>
          <p class="popup-text"> <b> Amarelo: </b> É necessária uma devida atenção. Isso acontece quando seu sensor está se aproximando dos extremos de uma umidade. </p>
        </div>

        <div class="row">
          <div class="color green"></div>
          <p class="popup-text"> <b> Verde: </b> A situação está segura. Isso acontece quando seu sensor está com a umidade em um ponto ideal. </p>
        </div>

        <button onclick="modal()" class="voltar">
          VOLTAR
        </button>

      </div>
    </div>

  </div>
</body>

</html>

<script>
 function filtrarSetor(mapeamentoSetores, resposta) {
    
    var setores = [[], [], [], []];

    for (var i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      var idSetor = registro.idSetor;



      if (mapeamentoSetores.includes(idSetor)) {
        var indiceSetor = mapeamentoSetores.indexOf(idSetor);
        setores[indiceSetor].push(registro);
      }
    }

    console.log(mapeamentoSetores);

    return setores;
  }


  let proximaAtualizacao;

  window.onload = obterDadosGraficos();

  function obterDadosGraficos() {
    obterDadosGrafico();
  }

  function obterDadosGrafico() {
    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/${sessionStorage.ID_CLUBE}/setores`, {
      cache: "no-store",
    })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            var setores = mapeamentoSetores(resposta);
            plotarGrafico(setores);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  const cores = ['green', 'blue', 'red', 'yellow'];

  function plotarGrafico(setores) {
    console.log("Iniciando plotagem do gráfico...");

    var labels = [];
    var dados = {
      labels: labels,
      datasets: [],
    };

    var horario = [];

    for (var posicaoSetor = 0; posicaoSetor < setores.length; posicaoSetor++) {
      var setor = setores[posicaoSetor];


      var dataset = {
        label: "Setor " + (posicaoSetor + 1),
        data: [],
        fill: false,
        borderColor: cores[posicaoSetor],
        tension: 0.1,
      };

      for (var j = 0; j < setor.length; j++) {
        var registro = setor[j];
        if (!horario.includes(registro.momento_grafico)) {
          horario.push(registro.momento_grafico);
          labels.push(registro.momento_grafico);
        }
        dataset.data.push(registro.umidade);
      }

      dados.datasets.push(dataset);
    }

    console.log("Labels:");
    console.log(labels);
    console.log("Dados:");
    console.log(dados.datasets);

    const config = {
      type: "line",
      data: dados,
    };

    var myChart = new Chart(document.getElementById("myChartCanvas1"), config);

    setTimeout(() => atualizarGrafico(dados, myChart), 2000);
  }

  function atualizarGrafico(dados, myChart) {
    fetch(`/medidas/tempo-real/${sessionStorage.ID_ESTADIO}/setores`, {
      cache: "no-store",
    })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            var setores = mapeamentoSetores(novoRegistro).reverse();
            console.log("Dados atuais do gráfico:");
            console.log(dados);

            var avisoCaptura = document.getElementById("avisoCaptura1");
            avisoCaptura.innerHTML = "";

            if (
              novoRegistro[0].momento_grafico ==
              dados.labels[dados.labels.length - 1]
            ) {
              console.log(
                "---------------------------------------------------------------"
              );
              console.log(
                "Como não há dados novos para captura, o gráfico não atualizará."
              );
              avisoCaptura.innerHTML =
                "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará.";
              console.log("Horário do novo dado capturado:");
              console.log(novoRegistro[0].momento_grafico);
              console.log("Horário do último dado capturado:");
              console.log(dados.labels[dados.labels.length - 1]);
              console.log(
                "---------------------------------------------------------------"
              );
            } else {
              dados.labels.shift();
              dados.labels.push(novoRegistro[0].momento_grafico);
              for (var i = 0; i < setores.length; i++) {
                var dataset = dados.datasets[i];
                var setor = setores[i];
                dataset.data.shift();


                if (setor.length > 0) {
                  var ultimoRegistroSetor = setor[setor.length - 1];
                  dataset.data.push(ultimoRegistroSetor.umidade);
                } else {
                  dataset.data.push(null);
                }
              }

              myChart.update();
            }

            proximaAtualizacao = setTimeout(
              () => atualizarGrafico(dados, myChart),
              2000
            );
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
          proximaAtualizacao = setTimeout(
            () => atualizarGrafico(dados, myChart),
            2000
          );
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }


</script>